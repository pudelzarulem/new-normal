<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stranger Shop - The Upside Down</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=Rubik+Glitch&display=swap" rel="stylesheet">
    <!-- –ò–∫–æ–Ω–∫–∏ Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- üî• –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –¢–í–û–ô –°–ï–ô–§ –° –ö–õ–Æ–ß–ê–ú–ò -->
    <script src="keys.js"></script>

    <style>
        :root {
            --stranger-red: #ff0033;
            --stranger-blue: #0ea5e9;
            --stranger-cyan: #22d3ee;
            --stranger-glow: #ff3e3e;
            --bg-color: #050505;
        }

        body {
            background: linear-gradient(to bottom, #020617 0%, #050505 40%, #1a0505 100%);
            background-attachment: fixed; 
            color: #e0e0e0;
            font-family: 'Courier Prime', monospace;
            overflow-x: hidden;
            user-select: none;
        }

        /* --- –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ --- */
        .stranger-title {
            font-family: 'Cinzel Decorative', serif;
            color: transparent;
            -webkit-text-stroke: 2px var(--stranger-red);
            text-stroke: 2px var(--stranger-red);
            text-shadow: 0 0 15px rgba(255, 0, 51, 0.4);
            letter-spacing: -1px;
        }

        .stranger-title.blue {
            -webkit-text-stroke: 2px var(--stranger-blue);
            text-stroke: 2px var(--stranger-blue);
            text-shadow: 0 0 20px rgba(14, 165, 233, 0.6);
        }

        .iznanka-logo {
            font-family: 'Rubik Glitch', cursive;
            color: #fff;
            --glow-color: var(--stranger-red); 
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px var(--glow-color), 0 0 40px var(--glow-color);
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: flicker 4s infinite;
        }

        .iznanka-logo.blue-theme { --glow-color: var(--stranger-blue); }
        .iznanka-logo.cyan-theme { --glow-color: var(--stranger-cyan); color: #ecfeff; }

        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% { opacity: 1; text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px var(--glow-color); }
            20%, 24%, 55% { opacity: 0.4; text-shadow: none; }
        }
        
        .neon-border-bottom {
            border-bottom: 2px solid var(--stranger-blue);
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.5);
        }

        @keyframes fast-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .cursor-blink { animation: fast-blink 0.8s infinite; }

        /* --- D20 ANIMATION --- */
        .d20-wrapper { perspective: 1000px; width: 150px; height: 150px; margin: 0 auto; position: relative; }
        .d20-die { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 1s ease-out; }
        .d20-die.rolling { animation: rollDice 0.5s infinite linear; }
        @keyframes rollDice { 0% { transform: rotateX(0) rotateY(0) rotateZ(0); } 100% { transform: rotateX(360deg) rotateY(720deg) rotateZ(360deg); } }
        .d20-svg-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
        .d20-svg { width: 100%; height: 100%; fill: #ea4c2a; stroke: rgba(255, 255, 255, 0.9); stroke-width: 3; stroke-linejoin: round; filter: drop-shadow(0 0 15px rgba(234, 76, 42, 0.6)); }
        .d20-svg.blue { fill: var(--stranger-blue); filter: drop-shadow(0 0 15px rgba(14, 165, 233, 0.6)); }
        .d20-number { position: absolute; font-family: 'Courier Prime', monospace; font-weight: 900; font-size: 3.5rem; color: white; text-shadow: 2px 2px 0px rgba(0,0,0,0.5); z-index: 10; }
        .d20-die.rolling .d20-number { opacity: 0.3; filter: blur(4px); }

        /* --- Components --- */
        .retro-card { background: rgba(0, 0, 0, 0.7); border: 1px solid #333; transition: all 0.3s ease; position: relative; overflow: hidden; cursor: pointer; }
        .retro-card:hover { border-color: var(--stranger-red); box-shadow: 0 0 15px rgba(255, 0, 51, 0.4); transform: translateY(-2px); }
        
        .retro-btn { border: 1px solid var(--stranger-red); color: var(--stranger-red); text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s ease; background: rgba(231, 29, 54, 0.05); cursor: pointer; box-shadow: 0 0 5px rgba(255, 0, 51, 0.2); }
        .retro-btn:hover { background: var(--stranger-red); color: black; box-shadow: 0 0 20px var(--stranger-red); }
        
        .retro-btn.blue { border-color: var(--stranger-blue); color: var(--stranger-blue); background: rgba(14, 165, 233, 0.05); box-shadow: 0 0 5px rgba(14, 165, 233, 0.2); }
        .retro-btn.blue:hover { background: var(--stranger-blue); color: black; box-shadow: 0 0 20px var(--stranger-blue); }

        .retro-btn.cyan { 
            border-color: var(--stranger-cyan); 
            color: var(--stranger-cyan); 
            background: rgba(34, 211, 238, 0.05); 
            box-shadow: 0 0 5px rgba(34, 211, 238, 0.2); 
        }
        .retro-btn.cyan:hover { 
            background: var(--stranger-cyan); 
            color: black; 
            box-shadow: 0 0 20px var(--stranger-cyan); 
        }

        .retro-btn.red { 
            border-color: #ef4444; 
            color: #ef4444; 
            background: rgba(239, 68, 68, 0.05); 
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); 
        }
        .retro-btn.red:hover { 
            background: #ef4444; 
            color: white; 
            box-shadow: 0 0 20px #ef4444; 
        }

        .retro-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .category-btn { font-family: 'Courier Prime', monospace; text-transform: uppercase; font-size: 0.75rem; padding: 0.5rem 1rem; border: 1px solid #333; color: #888; transition: all 0.3s; white-space: nowrap; background: rgba(0,0,0,0.5); }
        .category-btn:hover { border-color: var(--stranger-cyan); color: var(--stranger-cyan); box-shadow: 0 0 10px rgba(34, 211, 238, 0.3); }
        .category-btn.active { background: var(--stranger-cyan); color: black; border-color: var(--stranger-cyan); font-weight: bold; box-shadow: 0 0 15px var(--stranger-cyan); }

        .cart-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 29, 54, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 29, 54, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 29, 54, 0); } }

        /* FX Layers */
        .film-grain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; opacity: 0.05; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; z-index: 41; pointer-events: none; }
        .vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 50%, black 120%); z-index: 39; pointer-events: none; }
        #upside-down-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .content-layer { position: relative; z-index: 50; }
        .fade-in { animation: fadeIn 0.8s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* VECNA MODE */
        body.vecna-mode::after {
            content: ''; position: fixed; inset: 0; background: rgba(255, 0, 0, 0.2); pointer-events: none; z-index: 100; animation: pulseRed 2s infinite; mix-blend-mode: overlay;
        }
        @keyframes pulseRed { 0% { opacity: 0.1; } 50% { opacity: 0.4; } 100% { opacity: 0.1; } }

        /* ADMIN INPUTS */
        .admin-input { background: rgba(0,0,0,0.5); border: 1px solid #333; color: white; padding: 8px; font-family: 'Courier Prime', monospace; width: 100%; outline: none; }
        .admin-input:focus { border-color: var(--stranger-blue); box-shadow: 0 0 10px rgba(14, 165, 233, 0.3); }
        .admin-label { color: #888; font-size: 0.7rem; margin-bottom: 4px; display: block; text-transform: uppercase; }
    </style>
</head>
<body class="antialiased h-screen flex flex-col">

    <!-- FX -->
    <canvas id="upside-down-canvas"></canvas>
    <div class="film-grain"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="content-layer w-full h-full flex flex-col overflow-hidden">
        
        <!-- HEADER (SHOP) -->
        <header id="shop-header" class="hidden w-full neon-border-bottom bg-black/90 backdrop-blur-md p-4 flex justify-between items-center shrink-0 z-50">
            <div class="flex items-center gap-3">
                <button onclick="goBackToMenu()" class="text-sky-400 hover:text-white transition-colors group p-1" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é">
                    <i data-lucide="arrow-left" class="w-6 h-6 drop-shadow-[0_0_5px_cyan] group-hover:drop-shadow-[0_0_10px_white]"></i>
                </button>
                <div class="iznanka-logo blue-theme text-xl md:text-3xl cursor-pointer transition-all" onclick="resetApp()">The Upside Down</div>
            </div>
            <button onclick="toggleCart()" class="relative group">
                <i data-lucide="shopping-cart" class="text-cyan-400 w-6 h-6 drop-shadow-[0_0_8px_rgba(34,211,238,0.8)] group-hover:drop-shadow-[0_0_15px_white] transition-all"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-black text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden shadow-[0_0_10px_red]">0</span>
            </button>
        </header>

        <!-- HEADER (GACHA) -->
        <header id="gacha-header" class="hidden w-full neon-border-bottom bg-black/90 backdrop-blur-md p-4 flex justify-between items-center shrink-0 z-50 border-b-blue-500">
             <div class="flex items-center gap-3">
                <button onclick="goBackToMenu()" class="text-sky-400 hover:text-white transition-colors group p-1" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é">
                    <i data-lucide="arrow-left" class="w-6 h-6 drop-shadow-[0_0_5px_cyan] group-hover:drop-shadow-[0_0_10px_white]"></i>
                </button>
                <div class="iznanka-logo blue-theme text-xl md:text-3xl cursor-pointer">–ë–†–û–°–û–ö –°–£–î–¨–ë–´</div>
            </div>
        </header>

        <!-- HEADER (RADIO) -->
        <header id="radio-header" class="hidden w-full bg-black/90 backdrop-blur-md p-4 flex justify-between items-center shrink-0 z-50 border-b border-gray-700">
             <div class="flex items-center gap-3">
                <button onclick="goBackToMenu()" class="text-gray-400 hover:text-white transition-colors group p-1" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div class="iznanka-logo text-xl md:text-3xl cursor-pointer text-gray-300 !text-shadow-none animate-none">CEREBRO</div>
            </div>
            <div class="flex items-center gap-2">
                <div class="text-[10px] font-mono text-gray-500">SIGNAL</div>
                <div id="signal-led" class="signal-light"></div>
            </div>
        </header>

        <!-- MENU VIEW (DEFAULT) -->
        <main id="quiz-view" class="flex-grow flex flex-col items-center justify-center p-6 text-center">
            
            <!-- –í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –≤–∏–∑–∏—Ç–æ–≤) -->
            <div id="welcome-quiz-container" class="max-w-xl w-full hidden">
                <div class="mb-8">
                    <h1 class="stranger-title blue text-3xl md:text-5xl mb-4 leading-tight uppercase">
                        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å<br>–Ω–∞ —Ç—É —Å—Ç–æ—Ä–æ–Ω—É
                    </h1>
                </div>
                <!-- üî• –î–û–ë–ê–í–õ–ï–ù ID quiz-container –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –û–®–ò–ë–ö–ò -->
                <div id="quiz-container" class="bg-black/60 border border-red-900/40 p-8 rounded-sm backdrop-blur-sm fade-in">
                    <h2 id="question-text" class="text-xl md:text-2xl mb-8 font-bold text-gray-200"></h2>
                    <div id="answers-container" class="flex flex-col gap-4"></div>
                </div>
            </div>

            <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –µ—Å–ª–∏ –≤–∏–∑–∏—Ç –±—ã–ª) -->
            <div id="main-menu-container" class="max-w-xl w-full hidden">
                <div class="text-center fade-in flex flex-col items-center w-full max-w-md mx-auto">
                    <h1 class="text-3xl md:text-4xl text-cyan-400 font-bold mb-8 font-mono tracking-widest uppercase" style="text-shadow: 0 0 10px rgba(34, 211, 238, 0.6);">–°–ò–°–¢–ï–ú–ê –ù–ê–í–ò–ì–ê–¶–ò–ò<span class="cursor-blink">_</span></h1>
                    <div class="flex flex-col gap-4 w-full">
                        <button onclick="enterShop()" class="retro-btn px-8 py-4 text-xl font-bold tracking-widest w-full hover:bg-red-900/20">–ú–ê–ì–ê–ó–ò–ù</button>
                        <button onclick="enterGacha()" class="retro-btn cyan px-8 py-4 text-xl font-bold tracking-widest w-full shadow-[0_0_10px_rgba(34,211,238,0.3)]">–ë–†–û–°–û–ö –°–£–î–¨–ë–´</button>
                        <button onclick="startExperiment()" class="retro-btn px-8 py-4 text-xl font-bold tracking-widest w-full hover:bg-red-900/20 opacity-90 border-yellow-500 text-yellow-500 hover:shadow-[0_0_15px_yellow]">–ù–ê–ß–ê–¢–¨ –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢</button>
                        <button onclick="openRadioLink()" class="retro-btn px-8 py-4 text-xl font-bold tracking-widest w-full hover:bg-red-900/20">–†–ê–î–ò–û–≠–§–ò–†</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- EXPERIMENT VIEW (TEST) -->
        <div id="experiment-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-black/95">
             <div class="relative w-full max-w-lg bg-black border border-red-900 shadow-[0_0_50px_rgba(231,29,54,0.3)] p-8 fade-in text-center overflow-y-auto max-h-[90vh]">
                 <button onclick="closeExperiment()" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
                 
                 <div id="experiment-question-container">
                     <div class="text-xs text-gray-500 mb-2 font-mono" id="exp-progress">–í–û–ü–†–û–° 1 / 10</div>
                     <h2 id="exp-q-text" class="text-lg md:text-xl mb-6 font-bold text-gray-200 font-mono"></h2>
                     <div id="exp-answers" class="flex flex-col gap-4"></div>
                 </div>

                 <div id="experiment-result" class="hidden">
                     <div class="text-4xl mb-4">üß™</div>
                     <h2 class="text-2xl font-bold text-green-500 mb-2">–≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢ –ó–ê–í–ï–†–®–ï–ù</h2>
                     <p class="text-gray-400 mb-6 text-sm">–í–∞—à–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã. –í–∞–º –ø—Ä–∏—Å–≤–æ–µ–Ω —É—Ä–æ–≤–µ–Ω—å –¥–æ–ø—É—Å–∫–∞: 13%.</p>
                     
                     <div class="bg-gray-900 border border-green-500/50 p-4 mb-6 relative overflow-hidden group">
                         <div class="text-xs text-gray-500 uppercase mb-1">–í–∞—à –ª–∏—á–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</div>
                         <div id="generated-promo" class="text-2xl font-mono font-bold text-white tracking-[0.2em]"></div>
                         <div class="absolute inset-0 bg-green-500/10 animate-pulse pointer-events-none"></div>
                     </div>
                     
                     <p class="text-xs text-red-500 mb-6 blink">‚ö†Ô∏è –ö–û–î –î–ï–ô–°–¢–í–£–ï–¢ –û–î–ò–ù –†–ê–ó. –°–û–•–†–ê–ù–ò–¢–ï –ï–ì–û.</p>
                     
                     <button onclick="copyPromoAndClose()" class="retro-btn cyan w-full py-3">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ò –í–û–ô–¢–ò</button>
                 </div>
             </div>
        </div>

        <!-- ALREADY DONE MODAL -->
        <div id="already-done-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
            <div class="w-full max-w-md bg-gray-900 border border-gray-700 p-6 shadow-2xl fade-in text-center font-mono">
                <div class="text-yellow-500 text-4xl mb-4">‚ö†</div>
                <h3 class="text-xl font-bold text-white mb-2">–î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù</h3>
                <p class="text-gray-400 text-sm mb-6 leading-relaxed">
                    –°—É–±—ä–µ–∫—Ç —É–∂–µ –ø—Ä–æ—à–µ–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É —Å–∏–Ω–∞–ø—Å–æ–≤.
                    <br><br>
                    –ê—Ä—Ö–∏–≤–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞:
                </p>
                <div id="archived-promo" class="bg-black border border-gray-600 p-3 text-xl text-yellow-500 tracking-widest mb-6"></div>
                <button onclick="document.getElementById('already-done-modal').classList.add('hidden')" class="retro-btn w-full py-2">–ü–û–ù–Ø–¢–ù–û</button>
            </div>
        </div>

        <!-- CATALOG VIEW -->
        <main id="catalog-view" class="hidden flex-grow overflow-y-auto p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
                <div id="catalog-content" class="pb-20"></div>
            </div>
        </main>
        
        <!-- GACHA VIEW -->
        <main id="gacha-view" class="hidden flex-grow overflow-y-auto p-4 md:p-8 flex flex-col items-center">
             <div class="fade-in flex flex-col items-center justify-center py-4 w-full max-w-4xl">
                <p class="text-gray-500 text-sm mb-8 max-w-md text-center">20 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ò–∑–Ω–∞–Ω–∫–∏. –û–¥–∏–Ω –±—Ä–æ—Å–æ–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–≤–æ—é —Å—É–¥—å–±—É.</p>
                
                <!-- D20 CONTAINER -->
                <div class="d20-wrapper mb-8">
                    <div id="d20-die" class="d20-die">
                        <div class="d20-svg-container">
                            <svg viewBox="0 0 100 100" class="d20-svg blue">
                                <path d="M50 5 L95 25 L95 75 L50 95 L5 75 L5 25 Z" />
                                <path d="M50 5 L50 50 M95 25 L50 50 M95 75 L50 50 M50 95 L50 50 M5 75 L50 50 M5 25 L50 50" stroke="rgba(255,255,255,0.6)" fill="none"/>
                            </svg>
                            <div id="d20-number-display" class="d20-number">20</div>
                        </div>
                    </div>
                </div>

                <button id="roll-btn" onclick="rollD20()" class="retro-btn blue px-8 py-4 text-xl font-bold tracking-widest mb-8">
                    –ë–†–û–°–û–ö (200 ‚ÇΩ)
                </button>
                
                <div id="d20-result-area" class="w-full mb-12"></div>
                
                <!-- PREVIEW GRID -->
                <div class="w-full border-t border-gray-800 pt-8 pb-20">
                    <div class="flex justify-between items-end mb-6">
                        <h3 class="text-gray-500 text-xs tracking-[0.2em]">–í–û–ó–ú–û–ñ–ù–ê–Ø –î–û–ë–´–ß–ê (20)</h3>
                        <!-- ADMIN TOGGLE GACHA -->
                        <div class="flex gap-2">
                            <button onclick="loadProductsFromDb(true)" class="hidden text-[10px] font-mono tracking-widest border border-cyan-500 px-2 py-1 text-cyan-500 transition-colors" id="gacha-refresh-btn">
                                üîÑ –û–ë–ù–û–í–ò–¢–¨
                            </button>
                            <button onclick="toggleAdminMode()" class="text-[10px] font-mono tracking-widest border border-gray-800 px-2 py-1 hover:border-cyan-500 hover:text-cyan-500 transition-colors" id="gacha-admin-btn">
                                –£–ü–†–ê–í–õ–ï–ù–ò–ï
                            </button>
                        </div>
                    </div>

                    <div id="gacha-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 gap-2 opacity-80">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </main>

        <!-- RADIO VIEW -->
        <main id="radio-view" class="hidden flex-grow flex flex-col items-center justify-center p-6 relative overflow-hidden">
            <div class="static-noise" id="radio-static"></div>
            <div class="relative z-10 w-full max-w-2xl bg-black/80 border border-gray-700 p-8 rounded-lg shadow-2xl backdrop-blur-md">
                
                <div class="mb-6 flex justify-between items-end">
                    <div class="text-xs text-gray-500 font-mono">FM TUNER</div>
                    <div class="text-4xl font-mono text-red-500 font-bold" style="text-shadow: 0 0 10px red;" id="freq-display">00.0</div>
                </div>

                <!-- DIAL -->
                <div class="radio-dial-container">
                    <div class="radio-scale" id="radio-scale-marks">
                        <!-- Generated by JS -->
                    </div>
                    <div class="radio-needle"></div>
                    <input type="range" min="0" max="120" step="0.1" value="50" class="radio-input" id="radio-slider" oninput="tuneRadio(this.value)">
                </div>

                <!-- MESSAGE DISPLAY -->
                <div class="h-40 bg-black border border-gray-800 p-4 font-mono text-green-500 overflow-hidden relative">
                    <div class="scanlines opacity-50"></div>
                    <div id="radio-message" class="text-sm md:text-lg whitespace-pre-wrap leading-relaxed opacity-50 blur-[1px]">
                        ...–ü–û–ò–°–ö –°–ò–ì–ù–ê–õ–ê...
                    </div>
                </div>

                <div class="mt-6 flex justify-between items-center text-gray-600 text-xs font-mono">
                    <div>MODE: AM/FM</div>
                    <div>HAWKINS LABS</div>
                </div>
            </div>
        </main>

        <!-- ADMIN EDIT MODAL (–° –£–î–ê–õ–ï–ù–ò–ï–ú –ò –ë–≠–ö–ê–ü–û–ú) -->
        <div id="admin-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="toggleAdminModal()"></div>
            <div class="relative w-full max-w-md bg-gray-900 border border-cyan-500/50 shadow-[0_0_30px_rgba(34,211,238,0.2)] p-6 fade-in overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-cyan-400 font-mono tracking-widest">–ò–ó–ú–ï–ù–ï–ù–ò–ï –†–ï–ê–õ–¨–ù–û–°–¢–ò</h3>
                    <!-- –ö–ù–û–ü–ö–ê –ë–≠–ö–ê–ü–ê -->
                    <button onclick="exportDatabase()" class="text-xs bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded border border-gray-600 text-gray-300 flex items-center gap-1" title="–°–∫–∞—á–∞—Ç—å –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö">
                        <i data-lucide="download" class="w-3 h-3"></i> –ë–≠–ö–ê–ü
                    </button>
                </div>
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-collection"> <!-- üî• Stores 'products' or 'gacha' -->
                
                <div class="space-y-4">
                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
                    <div class="border border-dashed border-gray-600 p-4 text-center rounded hover:border-cyan-500 transition-colors relative group">
                        <input type="file" id="photo-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10" onchange="uploadImageToImgBB(this)">
                        <div id="upload-label" class="text-gray-400 text-xs pointer-events-none">
                            <i data-lucide="upload" class="mx-auto mb-2 w-6 h-6"></i>
                            <span class="font-bold block">–ù–ê–ñ–ú–ò –ß–¢–û–ë–´ –ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û</span>
                            (–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞)
                        </div>
                        <div id="upload-loading" class="hidden text-cyan-400 font-mono animate-pulse">
                            –ó–ê–ì–†–£–ó–ö–ê –ù–ê –°–ï–†–í–ï–†...
                        </div>
                    </div>

                    <div>
                        <label class="admin-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è —Å–∞–º–∞)</label>
                        <input type="text" id="edit-image" class="admin-input" placeholder="https://...">
                    </div>

                    <div>
                        <label class="admin-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                        <input type="text" id="edit-name" class="admin-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∞—Ñ–ª–∏ Eggo">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="admin-label">–¶–µ–Ω–∞ (‚ÇΩ) / –†–µ–¥–∫–æ—Å—Ç—å</label>
                            <input type="number" id="edit-price" class="admin-input" placeholder="2500">
                        </div>
                         <div>
                            <label class="admin-label">–û—Å—Ç–∞—Ç–æ–∫ (—à—Ç)</label>
                            <input type="number" id="edit-stock" class="admin-input" placeholder="10">
                        </div>
                    </div>
                    
                    <div>
                        <label class="admin-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="edit-desc" rows="3" class="admin-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
                    </div>
                </div>
                <div class="mt-8 flex flex-col gap-3">
                    <div class="flex gap-3">
                        <button id="save-btn" onclick="saveProductChange()" class="flex-1 retro-btn cyan py-3 font-bold">–°–û–•–†–ê–ù–ò–¢–¨</button>
                        <button onclick="toggleAdminModal()" class="flex-1 retro-btn py-3 font-bold text-gray-500 border-gray-500 hover:text-white">–û–¢–ú–ï–ù–ê</button>
                    </div>
                    <!-- –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø -->
                    <button onclick="deleteCurrentProduct()" class="w-full retro-btn red py-2 font-bold text-sm flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> –£–î–ê–õ–ò–¢–¨ –¢–û–í–ê–†
                    </button>
                </div>
            </div>
        </div>

        <!-- PRODUCT DETAILS MODAL (–ù–û–í–û–ï –û–ö–ù–û –ü–†–û–°–ú–û–¢–†–ê) -->
        <div id="product-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="closeProductModal()"></div>
            <div class="relative w-full max-w-lg bg-[#0a0a0a] border border-red-900/50 shadow-[0_0_50px_rgba(231,29,54,0.15)] flex flex-col fade-in overflow-hidden max-h-[90vh]">
                
                <button onclick="closeProductModal()" class="absolute top-2 right-2 z-20 text-white bg-black/50 rounded-full p-2 hover:bg-red-900 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <div class="h-64 sm:h-80 bg-gray-900 relative">
                    <img id="detail-image" src="" alt="" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 left-0 w-full h-20 bg-gradient-to-t from-black to-transparent"></div>
                </div>

                <div class="p-6 overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h2 id="detail-name" class="text-2xl font-bold text-white leading-tight font-mono tracking-wide"></h2>
                    </div>
                    
                    <p id="detail-desc" class="text-gray-400 text-sm leading-relaxed mb-6 font-mono"></p>
                    
                    <div class="flex items-end justify-between border-t border-gray-800 pt-6">
                        <div>
                            <div class="text-xs text-gray-500 mb-1 font-mono uppercase">–¶–µ–Ω–∞</div>
                            <div id="detail-price" class="text-3xl font-bold text-red-500 text-shadow-[0_0_10px_rgba(255,0,0,0.3)]"></div>
                        </div>
                        <div class="text-right">
                            <div id="detail-stock" class="text-xs text-gray-500 mb-2 font-mono"></div>
                            <button id="detail-add-btn" class="retro-btn px-6 py-3 font-bold text-lg flex items-center gap-2">
                                <span>–í –ö–û–†–ó–ò–ù–£</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DELIVERY MODAL (–û–§–û–†–ú–õ–ï–ù–ò–ï –î–û–°–¢–ê–í–ö–ò) -->
        <div id="delivery-modal" class="fixed inset-0 z-[65] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="backToCart()"></div>
            <div class="relative w-full max-w-md bg-[#0a0a0a] border border-cyan-500/30 shadow-[0_0_30px_rgba(34,211,238,0.1)] p-6 fade-in overflow-y-auto max-h-[90vh]">
                
                <!-- HEADER –° –ö–ù–û–ü–ö–û–ô –ù–ê–ó–ê–î -->
                <div class="relative mb-6 text-center">
                    <button onclick="backToCart()" class="absolute left-0 top-1 text-gray-500 hover:text-white transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <h3 class="text-xl font-bold text-cyan-400 font-mono tracking-widest">–î–û–°–¢–ê–í–ö–ê</h3>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="admin-label">–í–∞—à–µ –ò–º—è</label>
                        <input type="text" id="del-name" class="admin-input" placeholder="–ê–ª–µ–∫—Å–µ–π">
                    </div>
                    <div>
                        <label class="admin-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="del-phone" class="admin-input" placeholder="+7 999 000-00-00">
                    </div>
                    <div>
                        <label class="admin-label">–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <input type="text" id="del-time" class="admin-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–≥–æ–¥–Ω—è –∫ 19:00">
                    </div>
                    <div>
                        <label class="admin-label">–ì–æ—Ä–æ–¥</label>
                        <input type="text" id="del-city" class="admin-input" placeholder="–°–æ—á–∏">
                    </div>
                    <div>
                        <label class="admin-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <textarea id="del-address" rows="2" class="admin-input" placeholder="–£–ª–∏—Ü–∞, –î–æ–º, –ö–≤–∞—Ä—Ç–∏—Ä–∞"></textarea>
                    </div>
                    <div>
                        <label class="admin-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" id="del-comment" class="admin-input" placeholder="–ö–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞...">
                    </div>

                    <div class="border-t border-gray-800 pt-4 mt-4">
                        <div class="flex justify-between text-gray-400 text-sm mb-1">
                            <span>–¢–æ–≤–∞—Ä—ã:</span>
                            <span id="del-count">0 —à—Ç</span>
                        </div>
                        <div class="flex justify-between text-gray-400 text-sm mb-2">
                            <span>–î–æ—Å—Ç–∞–≤–∫–∞ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è):</span>
                            <span class="text-cyan-400">+ 300 ‚ÇΩ</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold text-white border-t border-gray-800 pt-2">
                            <span>–ò–¢–û–ì–û:</span>
                            <span id="del-total" class="text-cyan-400">0 ‚ÇΩ</span>
                        </div>
                    </div>
                </div>
                <button onclick="processPayment()" class="w-full mt-6 retro-btn cyan py-3 font-bold text-lg hover:shadow-[0_0_20px_cyan]">–ü–ï–†–ï–ô–¢–ò –ö –û–ü–õ–ê–¢–ï</button>
            </div>
        </div>

        <!-- CART MODAL -->
        <div id="cart-modal" class="fixed inset-0 z-[60] hidden">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleCart()"></div>
            <div class="absolute right-0 top-0 h-full w-full max-w-md bg-[#0a0a0a] border-l border-red-900 shadow-[0_0_50px_rgba(231,29,54,0.2)] flex flex-col transform transition-transform duration-300 translate-x-full" id="cart-panel">
                <div class="p-6 border-b border-red-900/30 flex justify-between items-center">
                    <h2 class="text-xl text-red-600 font-light tracking-widest iznanka-logo !text-2xl !animate-none !text-shadow-none" style="text-shadow: 0 0 10px red;">–í–ê–® –ù–ê–ë–û–†</h2>
                    <button onclick="toggleCart()" class="text-gray-500 hover:text-white">‚úï</button>
                </div>
                <div id="cart-items" class="flex-grow overflow-y-auto p-6 space-y-4"></div>
                <div class="p-6 border-t border-red-900/30 bg-black/50">
                    <div class="mb-4">
                        <label class="admin-label text-xs">–ü–†–û–ú–û–ö–û–î</label>
                        <div class="flex gap-2">
                            <input type="text" id="promo-input" class="admin-input flex-grow text-center uppercase tracking-widest font-mono text-sm" placeholder="XXXX-XXXX">
                            <button onclick="applyPromoCode()" class="retro-btn px-4 text-xs font-bold">–û–ö</button>
                        </div>
                    </div>
                    <div class="flex justify-between text-lg font-bold mb-6">
                        <span>–ò–¢–û–ì–û:</span>
                        <div class="text-right">
                             <span id="cart-total" class="text-red-500 text-shadow-[0_0_10px_red]">0 ‚ÇΩ</span>
                             <div id="discount-label" class="hidden text-xs text-green-500 font-mono">-13% –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢</div>
                        </div>
                    </div>
                    <!-- –î–í–ï –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–Ø -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="checkoutInstant()" class="retro-btn py-4 font-bold text-xs md:text-sm">–ó–ê–ë–†–ê–¢–¨ –°–ï–ô–ß–ê–°</button>
                        <button onclick="openDelivery()" class="retro-btn cyan py-4 font-bold text-xs md:text-sm">–û–§–û–†–ú–ò–¢–¨ –î–û–ú–û–ô</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <!-- –í–°–¢–ê–í–õ–Ø–ï–ú –°–ö–†–ò–ü–¢ –ó–ê–ì–†–£–ó–ö–ò (–ú–û–ñ–ù–û –ü–†–Ø–ú–û –ü–ï–†–ï–î <script type="module">) -->
    <script>
        // üî•üî• –í–°–¢–ê–í–¨ –°–Æ–î–ê –ö–õ–Æ–ß –û–¢ IMGBB (—à–∞–≥ 1) üî•üî•
        let IMGBB_KEY = "";
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
        if (window.STRANGER_KEYS) {
            IMGBB_KEY = window.STRANGER_KEYS.IMGBB_KEY;
        }

        async function uploadImageToImgBB(input) {
            const file = input.files[0];
            if (!file) return;

            // –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            document.getElementById('upload-label').classList.add('hidden');
            document.getElementById('upload-loading').classList.remove('hidden');

            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    // –£—Å–ø–µ—Ö! –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ –ø–æ–ª–µ
                    document.getElementById('edit-image').value = data.data.url;
                    
                    document.getElementById('upload-loading').innerText = "–ì–û–¢–û–í–û! –°–°–´–õ–ö–ê –ü–û–õ–£–ß–ï–ù–ê";
                    document.getElementById('upload-loading').classList.add('text-green-500');
                } else {
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + (data.error ? data.error.message : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                    resetUploadUI();
                }
            } catch (error) {
                console.error("Upload error:", error);
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
                resetUploadUI();
            }
        }

        function resetUploadUI() {
            document.getElementById('upload-label').classList.remove('hidden');
            document.getElementById('upload-loading').classList.add('hidden');
            document.getElementById('photo-upload').value = ""; // –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–ø—É—Ç
        }
    </script>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî•üî• –í–°–¢–ê–í–ò–¢–¨ –ö–û–ù–§–ò–ì –¢–£–¢ üî•üî•
        
        let firebaseConfig = {
            // apiKey: "...",
            // authDomain: "...",
            // ...
        };
        
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
        if (window.STRANGER_KEYS && window.STRANGER_KEYS.FIREBASE_CONFIG) {
            firebaseConfig = window.STRANGER_KEYS.FIREBASE_CONFIG;
        }

        let db;

        // Init Firebase safely
        try {
            if (firebaseConfig.projectId) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase connected!");
                
                // Expose to window for normal JS to use
                window.firebaseDb = db;
                window.firebaseUpdate = updateDoc;
                window.firebaseDoc = doc;
                window.firebaseSet = setDoc;
                window.firebaseGetDocs = getDocs;
                window.firebaseDelete = deleteDoc;
                window.firebaseCollection = collection;
                
                // Load products AND Gacha from DB immediately
                window.loadProductsFromDb();
            } else {
                console.warn("Firebase config missing. Running in DEMO mode.");
            }
        } catch (e) {
            console.error("Firebase init error:", e);
        }
    </script>

    <!-- JS LOGIC -->
    <script>
        lucide.createIcons();

        // 1. STATE VARIABLES
        let cart = [];
        let activeCategory = 'all';
        let isRolling = false;
        let isAdminMode = false;
        let discountApplied = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∫–∏–¥–∫–∏
        let currentWelcomeQuestions = [];
        let currentExperimentQuestions = [];
        let experimentCurrentQ = 0;

        // 2. DATA DEFINITIONS
        
        // üî• –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò
        const categories = [
            { id: 'all', name: '–í–°–ï –ú–ê–¢–ï–†–ò–ê–õ–´' },
            { id: 'passport', name: '–ü–†–û–ü–£–°–ö–ê' },
            { id: 'scent', name: '–õ–ê–ë–û–†–ê–¢–û–†–ò–Ø' },
            { id: 'kinder', name: '–ó–ê–ù–ê–ß–ö–ê' },
            { id: 'shopper', name: '–í–ï–©–ú–ï–®–ö–ò' },
            { id: '3d', name: '–ö–ê–°–¢–û–ú' },
        ];

        // 3. QUESTION POOLS
        
        // –ü—É–ª –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (15 —à—Ç, –≤—ã–±–∏—Ä–∞–µ–º 3)
        const welcomeQuizPool = [
            { q: "–®—É–º –Ω–∞ —á–µ—Ä–¥–∞–∫–µ. –î–µ–π—Å—Ç–≤–∏—è?", a: ["–ü—Ä–æ–≤–µ—Ä—é —Å —Ñ–æ–Ω–∞—Ä–∏–∫–æ–º", "–°–¥–µ–ª–∞—é –º—É–∑—ã–∫—É –≥—Ä–æ–º—á–µ", "–ü–æ–∑–≤–æ–Ω—é –¥—Ä—É–∑—å—è–º"] },
            { q: "–í—ã–±–µ—Ä–∏ –æ—Ä—É–∂–∏–µ:", a: ["–ë–∏—Ç–∞ —Å –≥–≤–æ–∑–¥—è–º–∏", "–†–æ–≥–∞—Ç–∫–∞", "–°–∏–ª–∞ –º—ã—Å–ª–∏"] },
            { q: "–í—Ä–µ–º—è —Å—É—Ç–æ–∫?", a: ["–ü–æ–ª–¥–µ–Ω—å", "–°—É–º–µ—Ä–∫–∏", "–ì–ª—É–±–æ–∫–∞—è –Ω–æ—á—å"] },
            { q: "–¢–≤–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç?", a: ["BMX", "–°–∫–µ–π—Ç", "–®–µ–≤—Ä–æ–ª–µ –ö–∞–º–∞—Ä–æ"] },
            { q: "–õ—é–±–∏–º–∞—è –µ–¥–∞?", a: ["–í–∞—Ñ–ª–∏ Eggo", "–ù—É–≥–∞", "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ"] },
            { q: "–ì–ª–∞–≤–Ω—ã–π —Å—Ç—Ä–∞—Ö?", a: ["–ö–ª–æ—É–Ω—ã", "–¢–µ–º–Ω–æ—Ç–∞", "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è"] },
            { q: "–¢–≤–æ—è —Ä–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ?", a: ["–õ–∏–¥–µ—Ä", "–†–∞–∑–≤–µ–¥—á–∏–∫", "–ü–∞–ª–∞–¥–∏–Ω"] },
            { q: "–ì–¥–µ —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è?", a: ["–®–∞–ª–∞—à –≤ –ª–µ—Å—É", "–ü–æ–¥–≤–∞–ª –ú–∞–π–∫–∞", "–ò–∑–Ω–∞–Ω–∫–∞"] },
            { q: "–ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–∏–≥–Ω–∞–ª?", a: ["–ì–∏—Ä–ª—è–Ω–¥–∞", "–†–∞—Ü–∏—è", "–°–∏–ª–∞ –º—ã—Å–ª–∏"] },
            { q: "–ì–ª–∞–≤–Ω—ã–π –≤—Ä–∞–≥?", a: ["–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω", "–ò—Å—Ç—è–∑–∞—Ç–µ–ª—å –†–∞–∑—É–º–∞", "–†—É—Å—Å–∫–∏–µ"] },
            { q: "–¢–≤–æ–π —Å—Ç–∏–ª—å?", a: ["80-–µ", "–ì—Ä–∞–Ω–∂", "–§–æ—Ä–º–∞ —Å–∫–∞—É—Ç–∞"] },
            { q: "–ß—Ç–æ —Å–ª—É—à–∞–µ—à—å?", a: ["–†–æ–∫-–Ω-—Ä–æ–ª–ª", "–°–∏–Ω—Ç–≤–µ–π–≤", "–¢–∏—à–∏–Ω—É"] },
            { q: "–õ—é–±–∏–º–∞—è –∏–≥—Ä–∞?", a: ["D&D", "Dragon's Lair", "–ü—Ä—è—Ç–∫–∏"] },
            { q: "–ì–¥–µ –≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è?", a: ["–®–∫–æ–ª–∞", "–°—Ç–∞—Ä–∫–æ—Ä—Ç –ú–æ–ª–ª", "–ê—Ä–∫–∞–¥–∞"] },
            { q: "–ö–∞—á–µ—Å—Ç–≤–æ –¥—Ä—É–≥–∞?", a: ["–ß–µ—Å—Ç–Ω–æ—Å—Ç—å", "–°–º–µ–ª–æ—Å—Ç—å", "–£–º"] }
        ];

        // –ü—É–ª –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (30 —à—Ç, –≤—ã–±–∏—Ä–∞–µ–º 10)
        const experimentQuizPool = [
            { q: "–ö–∞–∫–æ–≥–æ —Ü–≤–µ—Ç–∞ –Ω–µ–±–æ –≤ –ò–∑–Ω–∞–Ω–∫–µ?", a: ["–°–∏–Ω–µ–µ", "–ö—Ä–∞—Å–Ω–æ–µ", "–ß–µ—Ä–Ω–æ–µ"] },
            { q: "–ù–∞—Å—Ç–æ—è—â–µ–µ –∏–º—è –û–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å?", a: ["–î–∂–µ–π–Ω", "–°–∞—Ä–∞", "–ú—ç—Ä–∏"] },
            { q: "–ö–æ–≥–¥–∞ –∏—Å—á–µ–∑ –£–∏–ª–ª –ë–∞–π–µ—Ä—Å?", a: ["6 –Ω–æ—è–±—Ä—è 1983", "31 –æ–∫—Ç—è–±—Ä—è 1984", "25 –¥–µ–∫–∞–±—Ä—è 1983"] },
            { q: "–ö–∞–∫ –∑–æ–≤—É—Ç –±—Ä–∞—Ç–∞ –ú–∞–∫—Å?", a: ["–ë–∏–ª–ª–∏", "–°—Ç–∏–≤", "–î–∂–æ–Ω–∞—Ç–∞–Ω"] },
            { q: "–ö–∞–∫ –î–∞—Å—Ç–∏–Ω –Ω–∞–∑–≤–∞–ª —Å–≤–æ–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞?", a: ["–î‚Äô–ê—Ä—Ç–∞–Ω—å—è–Ω", "–õ—è–≥—É—à–∫–∞", "–ú—è—É—Ç"] },
            { q: "–û—Ä—É–∂–∏–µ –õ—É–∫–∞—Å–∞?", a: ["–†–æ–≥–∞—Ç–∫–∞", "–ü–∏—Å—Ç–æ–ª–µ—Ç", "–ë–∏—Ç–∞"] },
            { q: "–ì–¥–µ —Ä–∞–±–æ—Ç–∞–ª –°—Ç–∏–≤?", a: ["Scoops Ahoy", "RadioShack", "–ë–∞—Å—Å–µ–π–Ω"] },
            { q: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞?", a: ["–°—Ç–∞—Ä–∫–æ—Ä—Ç", "–•–æ—É–∫–∏–Ω—Å –ú–æ–ª–ª", "–ú–µ–≥–∞"] },
            { q: "–ß—Ç–æ –ø—å–µ—Ç —à–µ—Ä–∏—Ñ –•–æ–ø–ø–µ—Ä?", a: ["–ö–æ—Ñ–µ –∏ –ø–æ–Ω—á–∏–∫–∏", "–ü–∏–≤–æ", "–í–æ–¥—É"] },
            { q: "–ö–æ–¥–æ–≤–æ–µ –∏–º—è –ú—é—Ä—Ä–µ—è?", a: ["–õ—ã—Å—ã–π –û—Ä–µ–ª", "–û—Ä–µ–ª", "–°–æ–≤–∞"] },
            { q: "–õ—é–±–∏–º—ã–π –Ω–∞–ø–∏—Ç–æ–∫ –ê–ª–µ–∫—Å–µ—è?", a: ["–í–∏—à–Ω–µ–≤—ã–π —Å–º—É–∑–∏", "–ö–æ–ª–∞", "–í–æ–¥–∫–∞"] },
            { q: "–ö–∞–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ª–∏—Ü–æ –î–µ–º–æ–≥–æ—Ä–≥–æ–Ω–∞?", a: ["–ö–∞–∫ —Ü–≤–µ—Ç–æ–∫", "–ö–∞–∫ –∞–∫—É–ª–∞", "–ù–∏–∫–∞–∫"] },
            { q: "–ù–æ–º–µ—Ä '—Å–µ—Å—Ç—Ä—ã' –û–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å?", a: ["008", "009", "010"] },
            { q: "–ü—Ä–æ–∑–≤–∏—â–µ –ë–æ–±–∞ –ù—å—é–±–∏?", a: ["–ë–æ–±-–°—É–ø–µ—Ä–≥–µ—Ä–æ–π", "–ë–æ–±-–ú–æ–∑–≥", "–†–∞–¥–∏–æ-–ë–æ–±"] },
            { q: "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–ª—É–± D&D?", a: ["–ê–¥—Å–∫–æ–µ –ü–ª–∞–º—è", "–î—Ä–∞–∫–æ–Ω—ã", "–¢–∏–≥—Ä—ã"] },
            { q: "–ù–∞ —á–µ–º –∏–≥—Ä–∞–ª –≠–¥–¥–∏ –ú–∞–Ω—Å–æ–Ω?", a: ["–ì–∏—Ç–∞—Ä–∞", "–ë–∞—Ä–∞–±–∞–Ω—ã", "–ë–∞—Å"] },
            { q: "–°–ª–∞–±–æ—Å—Ç—å –í–µ–∫–Ω—ã?", a: ["–õ—é–±–∏–º–∞—è –º—É–∑—ã–∫–∞", "–û–≥–æ–Ω—å", "–í–æ–¥–∞"] },
            { q: "–ë–æ–ª–µ–∑–Ω—å –î–∞—Å—Ç–∏–Ω–∞?", a: ["–ö–ª—é—á–∏—á–Ω–æ-—á–µ—Ä–µ–ø–Ω–∞—è –¥–∏—Å–ø–ª–∞–∑–∏—è", "–ê—Å—Ç–º–∞", "–ù–µ—Ç –±–æ–ª–µ–∑–Ω–∏"] },
            { q: "–ö–æ–¥ '–í—Å–µ —á–∏—Å—Ç–æ'?", a: ["–ó–µ–ª–µ–Ω—ã–π", "–ù–∏–∑–∫–∏–π", "–°–∏–Ω–∏–π"] },
            { q: "–õ—é–±–∏–º–æ–µ –º–µ—Å—Ç–æ –≠—Ä–∏–∫–∏?", a: ["–í–µ–Ω—Ç–∏–ª—è—Ü–∏—è", "–ú–æ–ª–ª", "–®–∫–æ–ª–∞"] },
            { q: "–ì–¥–µ –∂–∏–≤–µ—Ç –°—å—é–∑–∏?", a: ["–Æ—Ç–∞", "–¢–µ—Ö–∞—Å", "–ú—ç–Ω"] },
            { q: "–ü–∞—Ä–æ–ª—å –æ—Ç –¶–µ—Ä–µ–±—Ä–æ?", a: ["–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ü–ª–∞–Ω–∫–∞", "–ß–∏—Å–ª–æ –ü–∏", "–î–∞—Ç–∞"] },
            { q: "–í–æ —á—Ç–æ –∏–≥—Ä–∞–ª–∏ –≤ –ø–æ–¥–≤–∞–ª–µ?", a: ["D&D", "–ú–æ–Ω–æ–ø–æ–ª–∏—è", "–†–∏—Å–∫"] },
            { q: "–ß–µ–≥–æ –±–æ—è—Ç—Å—è –î–µ–º–æ-–ø—Å—ã?", a: ["–û–≥–Ω—è", "–•–æ–ª–æ–¥–∞", "–°–≤–µ—Ç–∞"] },
            { q: "–ú–æ–Ω—Å—Ç—Ä 1 —Å–µ–∑–æ–Ω–∞?", a: ["–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω", "–ò—Å—Ç—è–∑–∞—Ç–µ–ª—å", "–í–µ–∫–Ω–∞"] },
            { q: "–ú–æ–Ω—Å—Ç—Ä 2 —Å–µ–∑–æ–Ω–∞?", a: ["–ò—Å—Ç—è–∑–∞—Ç–µ–ª—å –†–∞–∑—É–º–∞", "–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω", "–í–µ–∫–Ω–∞"] },
            { q: "–ú–æ–Ω—Å—Ç—Ä 3 —Å–µ–∑–æ–Ω–∞?", a: ["–ú–æ–Ω—Å—Ç—Ä –∏–∑ –ø–ª–æ—Ç–∏", "–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω", "–í–µ–∫–Ω–∞"] },
            { q: "–ì–ª–∞–≤–Ω—ã–π –∑–ª–æ–¥–µ–π 4 —Å–µ–∑–æ–Ω–∞?", a: ["–í–µ–∫–Ω–∞", "–ò—Å—Ç—è–∑–∞—Ç–µ–ª—å", "–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω"] },
            { q: "–ö–∞–∫ –î–∂–æ–π—Å –æ–±—â–∞–ª–∞—Å—å —Å –£–∏–ª–ª–æ–º?", a: ["–ì–∏—Ä–ª—è–Ω–¥—ã", "–¢–µ–ª–µ—Ñ–æ–Ω", "–ü–∏—Å—å–º–∞"] },
            { q: "–ú–∞—à–∏–Ω–∞ –•–æ–ø–ø–µ—Ä–∞?", a: ["–®–µ–≤—Ä–æ–ª–µ –ë–ª–µ–π–∑–µ—Ä", "–§–æ—Ä–¥", "–î–∂–∏–ø"] }
        ];

        // INITIAL FALLBACK DATA 
        let products = [
            // –ü–†–û–ü–£–°–ö–ê
            { id: 7, name: "Hawkins Lab ID", category: 'passport', price: 900, stock: 10, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=ID+Cover", desc: "–û–±–ª–æ–∂–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.", popular: false },
            { id: 54, name: "Snow Ball Ticket", category: 'passport', price: 800, stock: 15, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Ticket", desc: "–ë–∏–ª–µ—Ç –Ω–∞ –±–∞–ª.", popular: false },
            { id: 55, name: "Will's Drawing", category: 'passport', price: 700, stock: 8, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Draw", desc: "–†–∏—Å—É–Ω–æ–∫ –¢–µ–Ω—å.", popular: false },
            { id: 56, name: "Hopper's Letter", category: 'passport', price: 600, stock: 5, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Letter", desc: "–ü–∏—Å—å–º–æ –û–¥–∏.", popular: false },
            { id: 57, name: "Ru Code", category: 'passport', price: 850, stock: 12, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Code", desc: "–®–∏—Ñ—Ä —Ä—É—Å—Å–∫–∏—Ö.", popular: false },
            
            // –õ–ê–ë–û–†–ê–¢–û–†–ò–Ø
            { id: 10, name: "Essence of Void", category: 'scent', price: 1500, stock: 10, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Scent", desc: "–ê—Ä–æ–º–∞—Ç –æ–∑–æ–Ω–∞.", popular: false },
            { id: 30, name: "Waffle Syrup", category: 'scent', price: 1400, stock: 15, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Syrup", desc: "–ó–∞–ø–∞—Ö –∑–∞–≤—Ç—Ä–∞–∫–∞.", popular: false },
            { id: 31, name: "Arcade Popcorn", category: 'scent', price: 1400, stock: 8, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Popcorn", desc: "–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –ê—Ä–∫–∞–¥—ã.", popular: false },
            { id: 32, name: "Upside Down Ash", category: 'scent', price: 1600, stock: 4, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Ash", desc: "–ó–∞–ø–∞—Ö –ø–µ–ø–ª–∞.", popular: false },
            { id: 33, name: "Steve's Hairspray", category: 'scent', price: 1800, stock: 3, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Hair", desc: "–°–µ–∫—Ä–µ—Ç —É–∫–ª–∞–¥–∫–∏.", popular: false },
            
            // –ó–ê–ù–ê–ß–ö–ê
            { id: 9, name: "Demogorgon Egg", category: 'kinder', price: 2000, stock: 3, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=EGG", desc: "–°—é—Ä–ø—Ä–∏–∑ –≤–Ω—É—Ç—Ä–∏... –æ–ø–∞—Å–Ω—ã–π?", popular: false },
            { id: 23, name: "Dart's Special", category: 'kinder', price: 2100, stock: 5, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Nougat+Egg", desc: "–í–∫—É—Å –Ω—É–≥–∏.", popular: false },
            { id: 24, name: "Mind Flayer Dark", category: 'kinder', price: 2200, stock: 2, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Dark+Egg", desc: "–¢–µ–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥.", popular: false },
            
            // –í–ï–©–ú–ï–®–ö–ò
            { id: 8, name: "Loot Bag 'Starcourt'", category: 'shopper', price: 1200, stock: 9, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Shopper", desc: "–ü—Ä–æ—á–Ω—ã–π —à–æ–ø–ø–µ—Ä –∏–∑ –º–æ–ª–ª–∞.", popular: false },
            { id: 19, name: "Hellfire Tote", category: 'shopper', price: 1300, stock: 4, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=HF+Bag", desc: "–°—É–º–∫–∞ –¥–ª—è D&D.", popular: false },
            { id: 20, name: "Family Video Bag", category: 'shopper', price: 1100, stock: 12, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Video+Bag", desc: "–®–æ–ø–ø–µ—Ä –≤–∏–¥–µ–æ–ø—Ä–æ–∫–∞—Ç–∞.", popular: false },
            { id: 21, name: "Palace Arcade", category: 'shopper', price: 1250, stock: 6, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Arcade", desc: "–°—É–º–∫–∞ –¥–ª—è –∂–µ—Ç–æ–Ω–æ–≤.", popular: false },
            { id: 22, name: "Hawkins High Sack", category: 'shopper', price: 1400, stock: 8, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=School+Bag", desc: "–°–º–µ–Ω–∫–∞ '–¢–∏–≥—Ä–æ–≤'.", popular: false },
            
            // –ö–ê–°–¢–û–ú (5 –®–¢–£–ö)
            { id: 6, name: "D20 Critical", category: '3d', price: 300, stock: 40, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=D20", desc: "–°—Ç–∏–∫–µ—Ä D20.", popular: false },
            { id: 14, name: "Eleven's Power", category: '3d', price: 350, stock: 35, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=011+Hand", desc: "–†—É–∫–∞ –û–¥–∏.", popular: false },
            { id: 25, name: "Demogorgon Smile", category: '3d', price: 350, stock: 30, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Demo+Face", desc: "–ü–∞—Å—Ç—å –º–æ–Ω—Å—Ç—Ä–∞.", popular: false },
            { id: 26, name: "Hopper's Star", category: '3d', price: 350, stock: 25, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Sheriff", desc: "–ó–Ω–∞—á–æ–∫ —à–µ—Ä–∏—Ñ–∞.", popular: false },
            { id: 27, name: "Max's Walkman", category: '3d', price: 400, stock: 20, image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Walkman", desc: "–ü–ª–µ–µ—Ä –ú–∞–∫—Å.", popular: false }
        ];

        const secretChannels = [
            { freq: 11.0, msg: "–ú–ê–ô–ö? –ú–ê–ô–ö, –≠–¢–û –¢–´? –Ø –ó–î–ï–°–¨... –•–û–õ–û–î–ù–û...", type: "good" },
            { freq: 66.6, msg: "–Ø –í–ò–ñ–£ –¢–ï–ë–Ø. –ß–ê–°–´ –ü–†–û–ë–ò–õ–ò –ß–ï–¢–´–†–ï –†–ê–ó–ê.", type: "evil" }, // Vecna
            { freq: 85.0, msg: "AHOY! –≠–¢–û SCOOPS AHOY! –ü–†–û–ë–£–ô–¢–ï –ù–ê–®–£ –ù–û–í–ò–ù–ö–£ U.S.S. BUTTERSCOTCH!", type: "good" },
            { freq: 42.0, msg: "–î–õ–ò–ù–ù–ê–Ø. –ñ–ï–õ–¢–ê–Ø. –ö–û–®–ö–ê. –°–ú–û–¢–†–ò–¢. –ù–ê. –ó–ê–ü–ê–î.", type: "neutral" }, // Russian Code
            { freq: 102.5, msg: "ROCK N ROLL NEVER DIES, BABY!", type: "good" }, // Eddie
        ];

        // --- UTILS ---
        function getRandomQuestions(pool, count) {
            const shuffled = [...pool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // --- FIREBASE HELPER FUNCTIONS ---
        window.loadProductsFromDb = async function(force = false) {
            if (!window.firebaseDb) return;
            try {
                const querySnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDb, "products"));
                if (querySnapshot.empty) {
                    console.log("–ë–∞–∑–∞ –ø—É—Å—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.");
                } else {
                    products = [];
                    querySnapshot.forEach((doc) => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:", products.length);
                }

                const gachaSnapshot = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDb, "gacha"));
                if (!gachaSnapshot.empty) {
                    gachaPool = [];
                    gachaSnapshot.forEach((doc) => {
                        gachaPool.push({ id: doc.id, ...doc.data() });
                    });
                    gachaPool.sort((a,b) => a.id - b.id);
                    console.log("–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≥–∞—á–∞-–ø—Ä–µ–¥–º–µ—Ç–æ–≤:", gachaPool.length);
                } else {
                    gachaPool = [
                        { id: 201, name: "–ê—É–¥–∏–æ–∫–∞—Å—Å–µ—Ç–∞", image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Mixtape", desc: "–•–∏—Ç—ã 80-—Ö." },
                        { id: 202, name: "–ú–∏–Ω–∏ D20", image: "https://placehold.co/400x400/1a1a1a/e71d36?text=D20", desc: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Å–ø–µ—Ö." }
                    ];
                }
            } catch (e) {
                console.error("–û–®–ò–ë–ö–ê –ë–ê–ó–´! –†–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ.", e);
            }
            
            if (!document.getElementById('catalog-view').classList.contains('hidden')) renderProducts();
            if (!document.getElementById('gacha-view').classList.contains('hidden')) renderGacha();
            if(force) alert("–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
        }

        async function saveProductToDb(prod, collectionName) {
            if (window.firebaseDb) {
                try {
                    await window.firebaseSet(window.firebaseDoc(window.firebaseDb, collectionName, prod.id.toString()), prod);
                    return true;
                } catch(e) {
                    throw e;
                }
            } else {
                throw new Error("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π (–î–µ–º–æ —Ä–µ–∂–∏–º)");
            }
        }

        async function deleteProductFromDb() {
            if(!confirm("–¢—ã —É–≤–µ—Ä–µ–Ω? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã –ù–ê–í–°–ï–ì–î–ê.")) return;
            const id = document.getElementById('edit-id').value;
            const collectionName = document.getElementById('edit-collection').value;
            const btn = document.querySelector('#admin-modal button.red'); 
            const prevText = btn.innerHTML;
            btn.innerHTML = "‚è≥ –£–î–ê–õ–ï–ù–ò–ï...";
            btn.disabled = true;

            if (window.firebaseDb) {
                try {
                    await window.firebaseDelete(window.firebaseDoc(window.firebaseDb, collectionName, id.toString()));
                    if(collectionName === 'products') {
                        products = products.filter(p => p.id != id);
                    } else {
                        gachaPool = gachaPool.filter(p => p.id != id);
                    }
                    alert("üóëÔ∏è –¢–û–í–ê–† –£–î–ê–õ–ï–ù");
                    toggleAdminModal();
                    if(collectionName === 'products') renderProducts();
                    else renderGacha();
                } catch(e) {
                    alert("‚ùå –û–®–ò–ë–ö–ê: " + e.message);
                } finally {
                    btn.innerHTML = prevText;
                    btn.disabled = false;
                }
            } else {
                alert("‚ö†Ô∏è –†–ï–ñ–ò–ú –î–ï–ú–û: –í—Å—Ç–∞–≤—å –∫–ª—é—á–∏ Firebase!");
                btn.innerHTML = prevText;
                btn.disabled = false;
            }
        }

        async function exportDatabase() {
            if (!window.firebaseDb) {
                alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π!");
                return;
            }
            const btn = document.querySelector('button[title="–°–∫–∞—á–∞—Ç—å –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ –ó–ê–ì–†–£–ó–ö–ê...';
            btn.disabled = true;

            try {
                const productsSnap = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDb, "products"));
                const gachaSnap = await window.firebaseGetDocs(window.firebaseCollection(window.firebaseDb, "gacha"));
                const backupData = { date: new Date().toISOString(), products: [], gacha: [] };
                productsSnap.forEach(doc => backupData.products.push(doc.data()));
                gachaSnap.forEach(doc => backupData.gacha.push(doc.data()));
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stranger_shop_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert("–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –°–ø—Ä—è—á—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –Ω–∞–¥–µ–∂–Ω–æ–µ –º–µ—Å—Ç–æ.");
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- UI FUNCTIONS ---

        function renderQuiz() {
            // –ï—Å–ª–∏ –º—ã —É–∂–µ –∑–¥–µ—Å—å, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç.
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ –ø—É–ª–∞
            currentWelcomeQuestions = getRandomQuestions(welcomeQuizPool, 3);
            currentQuestion = 0;
            showWelcomeQuestion();
        }

        function showWelcomeQuestion() {
            const container = document.getElementById('welcome-quiz-container');
            const qText = document.getElementById('question-text');
            const aContainer = document.getElementById('answers-container');
            
            container.classList.remove('hidden');
            document.getElementById('main-menu-container').classList.add('hidden');

            const qContainerDiv = document.getElementById('quiz-container');
            qContainerDiv.classList.remove('fade-in'); void qContainerDiv.offsetWidth; qContainerDiv.classList.add('fade-in');

            if (currentQuestion >= currentWelcomeQuestions.length) { 
                finishQuiz(); 
                return; 
            }
            
            const data = currentWelcomeQuestions[currentQuestion];
            qText.innerText = `–í–û–ü–†–û–° 0${currentQuestion + 1}: ${data.q}`;
            aContainer.innerHTML = '';
            
            data.a.forEach(answer => {
                const btn = document.createElement('button');
                btn.className = 'retro-btn p-4 text-left w-full hover:pl-6 transition-all duration-300 font-bold text-sm md:text-base';
                btn.innerText = `> ${answer}`;
                btn.onclick = () => { currentQuestion++; showWelcomeQuestion(); };
                aContainer.appendChild(btn);
            });
        }

        function finishQuiz() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω
            localStorage.setItem('iznanka_visited', 'true');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
            document.getElementById('welcome-quiz-container').classList.add('hidden');
            document.getElementById('main-menu-container').classList.remove('hidden');
            document.getElementById('main-menu-container').classList.add('fade-in');
        }

        function hideAllViews() {
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('catalog-view').classList.add('hidden');
            document.getElementById('shop-header').classList.add('hidden');
            document.getElementById('gacha-view').classList.add('hidden');
            document.getElementById('gacha-header').classList.add('hidden');
            document.getElementById('radio-view').classList.add('hidden');
            document.getElementById('radio-header').classList.add('hidden');
            document.body.classList.remove('vecna-mode');
        }

        function enterShop() {
            hideAllViews();
            document.getElementById('shop-header').classList.remove('hidden');
            document.getElementById('catalog-view').classList.remove('hidden');
            document.getElementById('catalog-view').classList.add('fade-in');
            renderProducts();
        }
        
        function enterGacha() {
            hideAllViews();
            document.getElementById('gacha-header').classList.remove('hidden');
            document.getElementById('gacha-view').classList.remove('hidden');
            document.getElementById('gacha-view').classList.add('fade-in');
            renderGacha();
        }

        function enterRadio() {
            hideAllViews();
            document.getElementById('radio-header').classList.remove('hidden');
            document.getElementById('radio-view').classList.remove('hidden');
            document.getElementById('radio-view').classList.add('fade-in');
            renderRadioScale();
            tuneRadio(document.getElementById('radio-slider').value);
        }

        function openRadioLink() {
            let channelUrl = "https://t.me/";
            if (window.STRANGER_KEYS && window.STRANGER_KEYS.TELEGRAM_CHANNEL_URL) {
                channelUrl = window.STRANGER_KEYS.TELEGRAM_CHANNEL_URL;
            }
            window.open(channelUrl, '_blank');
        }

        function goBackToMenu() {
            hideAllViews();
            const quizView = document.getElementById('quiz-view');
            quizView.classList.remove('hidden');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –∞ –Ω–µ —Ç–µ—Å—Ç
            document.getElementById('main-menu-container').classList.remove('hidden');
            document.getElementById('welcome-quiz-container').classList.add('hidden');
        }

        // --- EXPERIMENT / DISCOUNT LOGIC ---
        function startExperiment() {
            if (localStorage.getItem('promo_generated')) {
                const code = localStorage.getItem('promo_code');
                document.getElementById('archived-promo').innerText = code;
                document.getElementById('already-done-modal').classList.remove('hidden');
                return;
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º 10 —Å–ª—É—á–∞–π–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            currentExperimentQuestions = getRandomQuestions(experimentQuizPool, 10);
            experimentCurrentQ = 0;
            
            document.getElementById('experiment-modal').classList.remove('hidden');
            renderExperimentQuiz();
        }

        function closeExperiment() {
            document.getElementById('experiment-modal').classList.add('hidden');
        }

        function renderExperimentQuiz() {
            if (experimentCurrentQ >= currentExperimentQuestions.length) {
                finishExperiment();
                return;
            }
            
            const qData = currentExperimentQuestions[experimentCurrentQ];
            document.getElementById('exp-progress').innerText = `–í–û–ü–†–û–° ${experimentCurrentQ + 1} / 10`;
            document.getElementById('exp-q-text').innerText = qData.q;
            
            const container = document.getElementById('exp-answers');
            container.innerHTML = '';
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º –∫–∞–∫ –µ—Å—Ç—å)
            qData.a.forEach(ans => {
                const btn = document.createElement('button');
                btn.className = 'retro-btn p-4 text-left w-full hover:pl-6 transition-all duration-300 font-bold text-sm md:text-base border-gray-600 text-gray-300 hover:border-red-500 hover:text-red-500';
                btn.innerText = `> ${ans}`;
                btn.onclick = () => { experimentCurrentQ++; renderExperimentQuiz(); };
                container.appendChild(btn);
            });
        }

        function finishExperiment() {
            document.getElementById('experiment-question-container').classList.add('hidden');
            const resultDiv = document.getElementById('experiment-result');
            resultDiv.classList.remove('hidden');
            resultDiv.classList.add('fade-in');

            const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
            const code = `STRANGER-${randomPart}`;
            
            document.getElementById('generated-promo').innerText = code;
            
            localStorage.setItem('promo_generated', 'true');
            localStorage.setItem('promo_code', code);
        }

        function copyPromoAndClose() {
            const code = localStorage.getItem('promo_code');
            const el = document.createElement('textarea');
            el.value = code;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert(`–ö–æ–¥ ${code} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ.`);
            closeExperiment();
        }

        function applyPromoCode() {
            const input = document.getElementById('promo-input');
            const code = input.value.trim().toUpperCase();
            const validCode = localStorage.getItem('promo_code');

            if (code === validCode) {
                if (!discountApplied) {
                    discountApplied = true;
                    updateCartUI();
                    alert("–°–∫–∏–¥–∫–∞ 13% –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! üß™");
                    input.disabled = true;
                    input.classList.add('text-green-500', 'border-green-500');
                } else {
                    alert("–°–∫–∏–¥–∫–∞ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞.");
                }
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞. –î–æ–ø—É—Å–∫ –∑–∞–ø—Ä–µ—â–µ–Ω.");
                input.classList.add('animate-pulse', 'border-red-500');
                setTimeout(() => input.classList.remove('animate-pulse', 'border-red-500'), 1000);
            }
        }

        // --- RADIO LOGIC ---
        function renderRadioScale() {
            const container = document.getElementById('radio-scale-marks');
            container.innerHTML = '';
            for(let i=0; i<=50; i++) {
                const mark = document.createElement('div');
                mark.className = `scale-mark ${i % 5 === 0 ? 'long' : ''}`;
                container.appendChild(mark);
            }
        }

        function tuneRadio(val) {
            const freq = parseFloat(val);
            document.getElementById('freq-display').innerText = freq.toFixed(1);
            let message = "...–ü–û–ò–°–ö –°–ò–ì–ù–ê–õ–ê...";
            let signalStrength = 0;
            let currentType = 'neutral';
            const range = 1.5; 
            secretChannels.forEach(ch => {
                const diff = Math.abs(ch.freq - freq);
                if (diff < range) {
                    const clarity = 1 - (diff / range); 
                    signalStrength = Math.max(signalStrength, clarity);
                    if (clarity > 0.8) { message = ch.msg; currentType = ch.type; } 
                    else if (clarity > 0.4) { message = scrambleText(ch.msg, 0.5); } 
                    else { message = scrambleText(ch.msg, 0.9); }
                }
            });
            const msgEl = document.getElementById('radio-message');
            const staticEl = document.getElementById('radio-static');
            const led = document.getElementById('signal-led');
            msgEl.innerText = message;
            if (signalStrength > 0.1) {
                msgEl.style.opacity = 0.5 + (signalStrength * 0.5);
                msgEl.style.filter = `blur(${(1-signalStrength)*2}px)`;
                staticEl.style.opacity = 0.3 - (signalStrength * 0.2);
                if (currentType === 'evil' && signalStrength > 0.8) {
                    document.body.classList.add('vecna-mode');
                    msgEl.style.color = '#ff0000'; msgEl.style.textShadow = '0 0 5px red';
                } else {
                    document.body.classList.remove('vecna-mode');
                    msgEl.style.color = '#22d3ee'; msgEl.style.textShadow = '0 0 5px cyan';
                }
            } else {
                msgEl.style.opacity = 0.3; msgEl.style.filter = 'blur(3px)'; staticEl.style.opacity = 0.4;
                document.body.classList.remove('vecna-mode'); msgEl.style.color = '#4ade80'; msgEl.style.textShadow = 'none';
            }
            if (signalStrength > 0.7) led.classList.add('active'); else led.classList.remove('active');
        }

        function scrambleText(text, factor) {
            return text.split('').map(char => {
                if (char === ' ') return ' ';
                return Math.random() < factor ? String.fromCharCode(33 + Math.floor(Math.random() * 90)) : char;
            }).join('');
        }

        // --- SHOP & ADMIN LOGIC ---
        function setCategory(id) { activeCategory = id; renderProducts(); }
        
        function toggleAdminMode() {
            if (isAdminMode) {
                isAdminMode = false;
            } else {
                const pass = prompt("–ö–û–î –î–û–°–¢–£–ü–ê:", "");
                if (pass === "1111") {
                    isAdminMode = true;
                    alert("–î–û–°–¢–£–ü –†–ê–ó–†–ï–®–ï–ù");
                } else if(pass) {
                    alert("–û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê");
                }
            }
            if (!document.getElementById('catalog-view').classList.contains('hidden')) renderProducts();
            if (!document.getElementById('gacha-view').classList.contains('hidden')) renderGacha();
        }

        function openEditModal(id, collection = 'products') {
            let item;
            if (collection === 'products') {
                item = products.find(prod => prod.id == id);
            } else {
                item = gachaPool.find(prod => prod.id == id);
            }
            if (!item) return;
            
            document.getElementById('edit-collection').value = collection;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-price').value = item.price || 0;
            document.getElementById('edit-stock').value = item.stock || 0;
            document.getElementById('edit-image').value = item.image;
            document.getElementById('edit-desc').value = item.desc;
            
            document.getElementById('admin-modal').classList.remove('hidden');
        }

        function toggleAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
        }

        // --- NEW PRODUCT DETAILS LOGIC ---
        function openProductDetails(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('detail-image').src = product.image;
            document.getElementById('detail-name').innerText = product.name;
            document.getElementById('detail-desc').innerText = product.desc;
            document.getElementById('detail-price').innerText = `${product.price} ‚ÇΩ`;
            
            const stockEl = document.getElementById('detail-stock');
            if(product.stock < 5) {
                stockEl.innerText = `–û–°–¢–ê–¢–û–ö: ${product.stock} (–ú–ê–õ–û!)`;
                stockEl.className = "text-xs text-red-500 mb-2 font-mono animate-pulse";
            } else {
                stockEl.innerText = `–û–°–¢–ê–¢–û–ö: ${product.stock}`;
                stockEl.className = "text-xs text-gray-500 mb-2 font-mono";
            }

            const btn = document.getElementById('detail-add-btn');
            btn.onclick = () => { addToCart(product.id); closeProductModal(); };
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        function deleteCurrentProduct() {
            deleteProductFromDb();
        }

        async function saveProductChange() {
            const id = document.getElementById('edit-id').value;
            const collectionName = document.getElementById('edit-collection').value; 
            const name = document.getElementById('edit-name').value;
            const price = parseInt(document.getElementById('edit-price').value);
            const stock = parseInt(document.getElementById('edit-stock').value);
            const image = document.getElementById('edit-image').value;
            const desc = document.getElementById('edit-desc').value;

            let targetArray = collectionName === 'products' ? products : gachaPool;
            const pIndex = targetArray.findIndex(p => p.id == id);

            if (pIndex !== -1) {
                targetArray[pIndex] = { ...targetArray[pIndex], name, price, stock, image, desc };
                const btn = document.getElementById('save-btn');
                const prevText = btn.innerText;
                btn.innerText = "‚è≥ –û–¢–ü–†–ê–í–ö–ê –í –û–ë–õ–ê–ö–û...";
                btn.disabled = true;
                
                try {
                    await saveProductToDb(targetArray[pIndex], collectionName);
                    btn.innerText = "‚úÖ –°–û–•–†–ê–ù–ï–ù–û";
                    btn.classList.add('bg-green-600', 'border-green-500');
                    setTimeout(() => {
                        toggleAdminModal();
                        btn.innerText = prevText;
                        btn.classList.remove('bg-green-600', 'border-green-500');
                        btn.disabled = false;
                        if (collectionName === 'products') renderProducts();
                        else renderGacha();
                    }, 1000);
                } catch (e) {
                    alert("‚ùå –û–®–ò–ë–ö–ê: " + e.message);
                    btn.innerText = "–ü–û–í–¢–û–†–ò–¢–¨";
                    btn.disabled = false;
                }
            }
        }

        function getProductCardHTML(product) {
             const stockClass = product.stock < 5 ? 'text-red-500 animate-pulse' : 'text-gray-500';
             const editBtn = isAdminMode ? `
                <button onclick="event.stopPropagation(); openEditModal(${product.id}, 'products')" class="absolute top-2 left-2 bg-cyan-500 text-black p-1 z-30 shadow-[0_0_10px_cyan] hover:scale-110 transition-transform">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                </button>
             ` : '';
             return `
                <div class="retro-card flex flex-col h-full group fade-in" onclick="openProductDetails(${product.id})">
                    <div class="relative overflow-hidden h-36 md:h-56 bg-gray-900 border-b border-gray-800">
                        ${editBtn}
                        <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-110 transition-transform duration-500">
                    </div>
                    <div class="p-3 md:p-4 flex flex-col flex-grow">
                        <h3 class="text-sm md:text-lg font-bold text-white mb-1 md:mb-2 leading-tight line-clamp-2">${product.name}</h3>
                        <p class="text-gray-500 text-[10px] md:text-xs mb-2 md:mb-4 flex-grow line-clamp-2">${product.desc}</p>
                        <div class="flex justify-between items-end mt-auto">
                            <span class="text-red-500 font-bold text-sm md:text-base text-shadow-[0_0_5px_red]">${product.price} ‚ÇΩ</span>
                            <div class="flex flex-col items-end gap-1">
                                <span class="text-[8px] md:text-[10px] ${stockClass} font-mono tracking-wider">–û–°–¢: ${product.stock}</span>
                                <button onclick="event.stopPropagation(); addToCart(${product.id})" class="retro-btn px-2 py-1 md:px-3 text-[10px] md:text-xs font-bold flex items-center gap-1 md:gap-2"><span>+</span> <span class="hidden sm:inline">–í –ö–û–†–ó–ò–ù–£</span><span class="sm:hidden">–í–ó–Ø–¢–¨</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function rollD20() {
            if (isRolling) return;
            isRolling = true;
            const dieElement = document.getElementById('d20-die');
            const resultArea = document.getElementById('d20-result-area');
            const btn = document.getElementById('roll-btn');
            const numberDisplay = document.getElementById('d20-number-display');
            
            btn.disabled = true;
            btn.innerText = "–í–†–ê–©–ï–ù–ò–ï...";
            resultArea.innerHTML = ''; 
            dieElement.classList.add('rolling');
            
            let shuffleInterval = setInterval(() => { numberDisplay.innerText = Math.floor(Math.random() * 20) + 1; }, 100);

            setTimeout(() => {
                clearInterval(shuffleInterval);
                dieElement.classList.remove('rolling');
                const rollResult = Math.floor(Math.random() * 20) + 1;
                numberDisplay.innerText = rollResult;
                
                if (gachaPool.length === 0) {
                     gachaPool = [
                        { id: 201, name: "–ê—É–¥–∏–æ–∫–∞—Å—Å–µ—Ç–∞", image: "https://placehold.co/400x400/1a1a1a/e71d36?text=Mixtape", desc: "–•–∏—Ç—ã 80-—Ö." },
                        { id: 202, name: "–ú–∏–Ω–∏ D20", image: "https://placehold.co/400x400/1a1a1a/e71d36?text=D20", desc: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Å–ø–µ—Ö." }
                     ];
                }

                const randomIndex = Math.floor(Math.random() * gachaPool.length);
                const wonItem = gachaPool[randomIndex];
                
                resultArea.innerHTML = `
                    <div class="fade-in mt-6 w-full max-w-sm mx-auto">
                        <div class="text-green-500 font-bold mb-2 text-xl font-mono">–°–£–î–¨–ë–ê –í–´–ë–†–ê–õ–ê:</div>
                        <div class="retro-card border-red-500 shadow-[0_0_20px_red]">
                            <div class="h-48 bg-gray-900 border-b border-red-900/50">
                                <img src="${wonItem.image}" class="w-full h-full object-cover">
                            </div>
                            <div class="p-4">
                                <h3 class="text-xl font-bold text-white mb-1">${wonItem.name}</h3>
                                <p class="text-gray-400 text-xs mb-3">${wonItem.desc}</p>
                                <div class="w-full bg-cyan-900/20 border border-cyan-500/50 p-2 text-center text-cyan-400 font-bold text-sm tracking-widest">
                                    –ü–û–õ–£–ß–ï–ù–û
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                isRolling = false;
                btn.disabled = false;
                btn.innerText = `–ë–†–û–°–û–ö (200 ‚ÇΩ)`;
            }, 2500);
        }
        
        function renderGacha() {
            const grid = document.getElementById('gacha-grid');
            const btn = document.getElementById('gacha-admin-btn');
            const refreshBtn = document.getElementById('gacha-refresh-btn');
            
            if(btn) btn.innerText = isAdminMode ? '–†–ï–ñ–ò–ú –ë–û–ì–ê: –í–ö–õ' : '–£–ü–†–ê–í–õ–ï–ù–ò–ï';
            if(btn) btn.className = `text-[10px] font-mono tracking-widest border border-gray-800 px-2 py-1 hover:border-cyan-500 hover:text-cyan-500 transition-colors ${isAdminMode ? 'text-cyan-500 border-cyan-500' : 'text-gray-600'}`;
            if(refreshBtn) refreshBtn.classList.toggle('hidden', !isAdminMode);

            grid.innerHTML = gachaPool.map((item, idx) => {
                 const editBtn = isAdminMode ? `
                    <button onclick="event.stopPropagation(); openEditModal(${item.id}, 'gacha')" class="absolute top-1 left-1 bg-cyan-500 text-black p-0.5 z-30 shadow-[0_0_5px_cyan] hover:scale-110 transition-transform rounded-sm">
                        <i data-lucide="pencil" class="w-3 h-3"></i>
                    </button>
                 ` : '';

                return `
                <div class="group relative aspect-square bg-gray-900 border border-gray-800 hover:border-red-500/50 transition-colors cursor-help rounded-sm overflow-hidden" title="${item.name}">
                    ${editBtn}
                    <img src="${item.image}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">
                    <div class="absolute bottom-0 right-0 bg-black/80 text-[8px] px-1 text-gray-400 font-mono">${idx + 1}</div>
                </div>
            `}).join('');
            
            updateCartUI();
            lucide.createIcons();
        }

        function renderProducts() {
            const container = document.getElementById('catalog-content');
            let html = `
                <div class="fade-in mb-8">
                      <div class="flex flex-col gap-6 mb-8">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl md:text-3xl font-normal tracking-widest iznanka-logo cyan-theme !animate-none !text-2xl" style="text-shadow: 0 0 10px var(--stranger-cyan);">–°–ö–õ–ê–î</h2>
                            <div class="h-[1px] bg-cyan-900/50 flex-grow shadow-[0_0_5px_cyan]"></div>
                            <div class="text-xs text-gray-500 font-mono">STORAGE</div>
                        </div>
                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                            ${categories.map(cat => `
                                <button onclick="setCategory('${cat.id}')" class="category-btn ${activeCategory === cat.id ? 'active' : ''}">${cat.name}</button>
                            `).join('')}
                        </div>
                        
                        <!-- ADMIN TOGGLE -->
                        <div class="flex justify-end gap-2">
                            <button onclick="loadProductsFromDb(true)" class="hidden text-[10px] font-mono tracking-widest border border-cyan-500 px-2 py-1 text-cyan-500 transition-colors" id="shop-refresh-btn">
                                üîÑ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø
                            </button>
                            <button onclick="toggleAdminMode()" class="text-[10px] font-mono tracking-widest border border-gray-800 px-2 py-1 hover:border-cyan-500 hover:text-cyan-500 transition-colors ${isAdminMode ? 'text-cyan-500 border-cyan-500' : 'text-gray-600'}">
                                ${isAdminMode ? '–†–ï–ñ–ò–ú –ë–û–ì–ê: –í–ö–õ' : '–£–ü–†–ê–í–õ–ï–ù–ò–ï'}
                            </button>
                        </div>

                    </div>
                </div>
            `;

            let itemsToDisplay = products;
            if (activeCategory !== 'all') { itemsToDisplay = products.filter(p => p.category === activeCategory); }

            if (itemsToDisplay.length > 0) {
                html += `<div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-6 fade-in">${itemsToDisplay.map(p => getProductCardHTML(p)).join('')}</div>`;
            } else {
                html += `<div class="text-center py-10 text-gray-500 font-mono fade-in">–ü–£–°–¢–û–¢–ê...</div>`;
            }
            container.innerHTML = html;
            
            // Show refresh button if admin
            const refreshBtn = document.getElementById('shop-refresh-btn');
            if(refreshBtn) refreshBtn.classList.toggle('hidden', !isAdminMode);
            
            lucide.createIcons();
        }

        function addToCart(id) {
            const product = products.find(p => p.id === id);
            cart.push(product); updateCartUI();
            
            if(event && event.currentTarget) {
                const btn = event.currentTarget;
                if(btn.id !== 'detail-add-btn') {
                    btn.innerHTML = "–î–û–ë–ê–í–õ–ï–ù–û!"; btn.classList.add("bg-red-900", "text-white");
                    setTimeout(() => { btn.innerHTML = `<span>+</span> <span class="hidden sm:inline">–í –ö–û–†–ó–ò–ù–£</span><span class="sm:hidden">–í–ó–Ø–¢–¨</span>`; btn.classList.remove("bg-red-900", "text-white"); }, 1000);
                }
            }
        }

        function removeFromCart(index) { cart.splice(index, 1); updateCartUI(); }

        function updateCartUI() {
            const countBadge = document.getElementById('cart-count');
            const cartItemsContainer = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');

            const count = cart.length;
            
            if (count > 0) { 
                countBadge.innerText = count; 
                countBadge.classList.remove('hidden'); 
                countBadge.classList.add('cart-badge'); 
            } else { 
                countBadge.classList.add('hidden'); 
                countBadge.classList.remove('cart-badge'); 
            }

            if (cart.length === 0) { cartItemsContainer.innerHTML = '<div class="text-center text-gray-600 mt-10">–ü—É—Å—Ç–æ...</div>'; } 
            else {
                cartItemsContainer.innerHTML = cart.map((item, index) => `
                    <div class="flex items-center justify-between bg-white/5 p-3 border border-gray-800">
                        <div class="flex items-center gap-3">
                            <img src="${item.image}" class="w-10 h-10 object-cover border border-gray-700">
                            <div><div class="text-sm font-bold text-gray-300">${item.name}</div><div class="text-xs text-red-500">${item.price} ‚ÇΩ</div></div>
                        </div>
                        <button onclick="removeFromCart(${index})" class="text-gray-500 hover:text-red-500">‚úï</button>
                    </div>
                `).join('');
            }
            let total = cart.reduce((sum, item) => sum + item.price, 0);
            
            if (discountApplied) {
                total = Math.floor(total * 0.87); 
                document.getElementById('discount-label').classList.remove('hidden');
            } else {
                document.getElementById('discount-label').classList.add('hidden');
            }

            totalEl.innerText = `${total} ‚ÇΩ`;
        }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            if (modal.classList.contains('hidden')) { modal.classList.remove('hidden'); setTimeout(() => panel.classList.remove('translate-x-full'), 10); } 
            else { panel.classList.add('translate-x-full'); setTimeout(() => modal.classList.add('hidden'), 300); }
        }

        function checkoutInstant() {
            if(cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            const finalTotal = discountApplied ? Math.floor(total * 0.87) : total;
            
            const orderData = {
                type: "PICKUP",
                items: cart,
                total: finalTotal,
                date: new Date().toISOString()
            };
            
            console.log("Instant Checkout:", orderData);
            alert(`ü§ù –û–ü–õ–ê–¢–ê –ù–ê –ú–ï–°–¢–ï!\n–°—É–º–º–∞: ${finalTotal} ‚ÇΩ\n–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –≤–æ–¥–∏—Ç–µ–ª—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä.`);
            
            cart = [];
            discountApplied = false;
            updateCartUI();
            toggleCart();
        }

        function openDelivery() {
            if(cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
            toggleCart(); 
            
            let total = cart.reduce((sum, item) => sum + item.price, 0);
            if(discountApplied) total = Math.floor(total * 0.87);

            // Add delivery cost
            const grandTotal = total + 300;

            document.getElementById('del-total').innerText = grandTotal + " ‚ÇΩ";
            document.getElementById('del-count').innerText = cart.length + " —à—Ç";
            
            document.getElementById('delivery-modal').classList.remove('hidden');
        }

        function toggleDelivery() {
            document.getElementById('delivery-modal').classList.add('hidden');
        }

        function backToCart() {
            toggleDelivery();
            setTimeout(() => {
                const modal = document.getElementById('cart-modal');
                const panel = document.getElementById('cart-panel');
                modal.classList.remove('hidden'); 
                requestAnimationFrame(() => {
                    panel.classList.remove('translate-x-full');
                });
            }, 50);
        }

        function processPayment() {
            const name = document.getElementById('del-name').value;
            const phone = document.getElementById('del-phone').value;
            const address = document.getElementById('del-address').value;
            const time = document.getElementById('del-time').value;
            
            if(!name || !phone || !address || !time) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            
            let total = cart.reduce((sum, item) => sum + item.price, 0);
            if(discountApplied) total = Math.floor(total * 0.87);
            
            // Add delivery
            const grandTotal = total + 300;

            const orderData = {
                type: "DELIVERY",
                user: name,
                phone: phone,
                address: address,
                time: time,
                items: cart,
                total: grandTotal,
                date: new Date().toISOString()
            };
            
            console.log("Delivery Order:", orderData);
            alert(`–ó–ê–ö–ê–ó –ü–†–ò–ù–Ø–¢!\n–°—É–º–º–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π: ${grandTotal} ‚ÇΩ\n–û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º.\n–ñ–¥–∏—Ç–µ –∑–≤–æ–Ω–∫–∞ –Ω–∞ ${phone}`);
            
            cart = [];
            discountApplied = false;
            updateCartUI();
            toggleDelivery();
        }

        function resetApp() { location.reload(); }

        // üî• MODIFIED WINDOW ONLOAD - No Auto Quiz, Direct to Menu
        window.onload = () => { 
            // Check if quiz already done
            if (localStorage.getItem('iznanka_visited')) {
                finishQuiz();
            } else {
                renderQuiz(); 
            }
            initParticles(); 
            animate(); 
        };

        const canvas = document.getElementById('upside-down-canvas');
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];
        function initParticles() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; particles = []; const count = window.innerWidth < 768 ? 40 : 80; for(let i=0; i<count; i++) particles.push(new Particle()); }
        class Particle { constructor() { this.reset(); } reset() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.size = Math.random() * 2 + 0.5; this.alpha = Math.random() * 0.5 + 0.1; this.life = Math.random() * 100; } update() { this.x += this.vx; this.y += this.vy; this.life--; if(this.life <= 0 || this.alpha <= 0 || this.x<0 || this.x>width) this.reset(); } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fillStyle = `rgba(180, 180, 200, ${this.alpha})`; ctx.fill(); } }
        function animate() { ctx.clearRect(0, 0, width, height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
        window.addEventListener('resize', initParticles);
    </script>
</body>
</html>